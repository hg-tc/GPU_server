[Unit]
Description=GPU Model Server (PDF + Embedding + Rerank)
After=network.target
Wants=nginx.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/GPU_server
Environment="PATH=/root/GPU_server/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Environment="HF_HUB_OFFLINE=1"
Environment="TRANSFORMERS_OFFLINE=1"
Environment="HF_DATASETS_OFFLINE=1"
Environment="HF_HUB_DISABLE_EXPERIMENTAL_WARNING=1"
Environment="HF_HUB_DISABLE_VERSION_CHECK=1"
Environment="CUDA_VISIBLE_DEVICES=0"
Environment="FORCE_CUDA=1"
Environment="EMBED_MODEL_NAME=BAAI/bge-large-zh-v1.5"
Environment="RERANKER_MODEL_NAME=BAAI/bge-reranker-v2-m3"
Environment="MARKER_USE_LLM=false"
Environment="PDFTEXT_WORKERS=1"
ExecStart=/root/GPU_server/venv/bin/uvicorn main:app --host 0.0.0.0 --port 18001 --workers 1 --timeout-keep-alive 300 --timeout-graceful-shutdown 30
ExecStartPost=/bin/bash -c 'sleep 2 && systemctl start nginx || true'
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=gpu-server

# 资源限制（可根据实际情况调整）
LimitNOFILE=65536
MemoryLimit=32G

[Install]
WantedBy=multi-user.target

